#!/usr/bin/env bash
set -eo pipefail
source /usr/bin/entrypoint

DATABASES=$(mysql --user=${MARIADB_ROOT_USERNAME} --password=${MARIADB_ROOT_PASSWORD} -e 'SHOW DATABASES;' | sed 1d | grep -v -E "(mysql|information_schema|performance_schema|sys)")
MAXIMUM=14

if [ "${DATABASES}" == "" ]; then
    exit
fi

if [ ! -d /var/lib/backup ]; then
    mkdir -p /var/lib/backup
    chmod u=rwx,g=rwx,o= /var/lib/backup
fi

for (( COUNTER=${MAXIMUM}; COUNTER>=1; COUNTER-- )); do
    if [ -d /var/lib/backup/backup.${COUNTER} ]; then
        DEST=`expr ${COUNTER} + 1`

        if [ ${DEST} -le ${MAXIMUM} ]; then
            rm -rf /var/lib/backup/backup.${DEST}
            mv /var/lib/backup/backup.${COUNTER} /var/lib/backup/backup.${DEST}
        fi
    fi
done

mkdir -p /var/lib/backup/backup.1
chmod u=rwx,g=rwx,o= /var/lib/backup/backup.1

cd /var/lib/backup/backup.1

for DATABASE in ${DATABASES}; do
    echo "Starting backup for ${DATABASE}..."
    START=$(date +%s)
    mysqldump --single-transaction --skip-add-locks --skip-lock-tables --user=${MARIADB_ROOT_USERNAME} --password=${MARIADB_ROOT_PASSWORD} --databases ${DATABASE} | gzip >| "${DATABASE}.sql.gz"
    chmod u=rwx,g=rwx,o= "${DATABASE}.sql.gz"
    ENDS=$(date +%s)
    echo "Done within $((${ENDS}-${START}))s"
done
